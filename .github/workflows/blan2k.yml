name: Ultimate-Win10-CRD-Counter

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    steps:
    
      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ (Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©)
      # -----------------------------------------------------------
      - name: Manage External Counter (Gist)
        shell: pwsh
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          $headers = @{
              "Authorization" = "token $env:GIST_TOKEN"
              "Accept" = "application/vnd.github.v3+json"
          }
          $url = "https://api.github.com/gists/$env:GIST_ID"

          $success = $false
          $retryCount = 0

          # Ø­Ù„Ù‚Ø© ØªÙƒØ±Ø§Ø± Ù„Ø§ ØªØªÙˆÙ‚Ù Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
          while (-not $success) {
              try {
                  Write-Host "ğŸ”„ Fetching current counter (Attempt: $($retryCount + 1))..."

                  # 1. Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Gist
                  # Ø§Ø³ØªØ®Ø¯Ø§Ù… ErrorAction Stop Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                  $response = Invoke-RestMethod -Uri $url -Headers $headers -Method Get -ErrorAction Stop
                  $currentCount = [int]$response.files."counter.txt".content
                  
                  # 2. Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ù…Ù‚Ø¯Ø§Ø± 1
                  $newCount = $currentCount + 1
                  Write-Host "ğŸ”¢ Proposed New Value: $newCount"

                  # 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Gist
                  $body = @{
                      files = @{
                          "counter.txt" = @{
                              content = [string]$newCount
                          }
                      }
                  } | ConvertTo-Json -Depth 10

                  Invoke-RestMethod -Uri $url -Headers $headers -Method Patch -Body $body -ErrorAction Stop
                  
                  # 4. Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                  echo "DEVICE_NUM=$newCount" >> $env:GITHUB_ENV
                  
                  Write-Host "âœ… Counter Updated Successfully to: $newCount"
                  $success = $true # ÙƒØ³Ø± Ø§Ù„Ø­Ù„Ù‚Ø© Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ø¬Ø­Øª
              }
              catch {
                  Write-Warning "âš ï¸ Failed to update counter (likely collision or network error)."
                  Write-Warning $_.Exception.Message
                  
                  # Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨ÙŠÙ† 1 Ùˆ 5 Ø«ÙˆØ§Ù†ÙŠ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¶ØºØ· ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªØµØ§Ø¯Ù… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                  $sleepTime = Get-Random -Minimum 1 -Maximum 6
                  Write-Host "â³ Retrying in $sleepTime seconds..."
                  Start-Sleep -Seconds $sleepTime
                  
                  $retryCount++
              }
          }

      - name: Download Chrome Installer
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "chrome_installer.exe"
          Start-Process -FilePath "chrome_installer.exe" -Args "/silent /install" -Wait

      - name: Download and Install CRD
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi"
          Start-Process -FilePath "msiexec.exe" -Args "/i crd.msi /quiet /qn" -Wait

      # ØªØ«Ø¨ÙŠØª VirtualBox
      - name: Install VirtualBox 6.1.48
        shell: pwsh
        run: |
          Write-Host "â¬‡ï¸ Downloading VirtualBox..."
          $vboxUrl = "https://download.virtualbox.org/virtualbox/6.1.48/VirtualBox-6.1.48-159471-Win.exe"
          $installerPath = "VirtualBox-Setup.exe"
           
          (New-Object System.Net.WebClient).DownloadFile($vboxUrl, $installerPath)
           
          Write-Host "âš™ï¸ Installing VirtualBox..."
          Start-Process -FilePath $installerPath -Args "--silent --ignore-reboot" -Wait
          Write-Host "âœ… VirtualBox Installed Successfully!"

      # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙƒØ¨ÙŠØ± Ø¹Ù„Ù‰ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ (Desktop)
      - name: Download and Extract to DESKTOP
        shell: cmd
        run: |
          @echo off
          echo â¬‡ï¸ Downloading large file directly to Desktop...
           
          REM ================================================================
          REM Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
          set "FILE_URL=https://huggingface.co/datasets/swelam100/rdp/resolve/main/win.zip"
          REM ================================================================

          REM Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
          cd /d "%USERPROFILE%\Desktop"
           
          REM Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Curl
          curl -L -o BigFile.zip "%FILE_URL%"

          echo ğŸ“¦ Extracting files here...
          7z x BigFile.zip -y
           
          echo ğŸ§¹ Cleaning up zip file...
          del BigFile.zip
           
          echo Files Downloaded Successfully > "Download_Complete.txt"
           
          echo âœ… Done! Files are on your Desktop.

      - name: Start Chrome Remote Desktop
        shell: pwsh
        env:
          CRD_CODE: ${{ secrets.CRD_CODE2 }}
          CRD_PIN: ${{ secrets.CRD_PIN }}
        run: |
          $exePath = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
           
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙŠ Ø§Ù„ØªØ³Ù…ÙŠØ©
          # Ù…Ø«Ø§Ù„ Ù„Ù„ØªØ³Ù…ÙŠØ©: MyAccount-Machine-5
          $UniqueName = "${{ github.actor }}-Machine-${{ env.DEVICE_NUM }}"
           
          Write-Host "======================================================"
          Write-Host "ğŸ–¥ï¸ SETTING RDP NAME TO: $UniqueName"
          Write-Host "======================================================"
           
          & $exePath --code="$env:CRD_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="$UniqueName" --pin=$env:CRD_PIN

      - name: Success Message
        shell: pwsh
        run: |
          Write-Host "======================================================"
          Write-Host "âœ… Windows 10 Environment is READY!"
           
          # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ø±Ø¶
          $FinalName = "${{ github.actor }}-Machine-${{ env.DEVICE_NUM }}"
           
          Write-Host "ğŸ‘‰ Connect to the PC named '$FinalName' using your PIN."
          Write-Host "======================================================"

      - name: Keep Alive
        shell: pwsh
        run: |
          while ($true) { Start-Sleep -Seconds 300 }
